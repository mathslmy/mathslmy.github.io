<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ™ºèƒ½åª’ä½“åŠ©æ‰‹</title>
<style>
  body { font-family: Arial, sans-serif; padding:20px; background:#f5f5f5; }
  h1 { text-align:center; margin-bottom:20px; }
  .container { max-width:850px; margin:0 auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
  .section { margin-bottom:25px; padding:15px; border:1px solid #ccc; border-radius:8px; background:#fafafa; }
  h3 { margin-bottom:10px; }
  label { display:block; margin:8px 0; }
  input,select { width:100%; padding:6px; margin-top:5px; }
  input[type="file"]{ padding:0; }
  button { margin-top:10px; padding:8px 16px; border:none; border-radius:5px; background:#4CAF50; color:#fff; cursor:pointer; }
  button:hover { background:#45a049; }
  #status { margin-top:20px; white-space:pre-wrap; font-size:14px; padding:10px; background:#eef; border-radius:6px; }
  .preview { margin-top:10px; max-width:100%; border:1px solid #ddd; border-radius:6px; }
</style>
</head>
<body>

<h1>æ™ºèƒ½åª’ä½“åŠ©æ‰‹</h1>
<div class="container">

  <!-- âš™ï¸ æ’ä»¶è®¾ç½® -->
  <div class="section">
    <h3>æ’ä»¶è®¾ç½®</h3>
    <label><input type="checkbox" id="enableImageProcessing" checked> å¯ç”¨å›¾ç‰‡å¤„ç†</label>
    <label><input type="checkbox" id="enableDocumentProcessing" checked> å¯ç”¨æ–‡æ¡£å¤„ç†</label>
    <label>å›¾ç‰‡è´¨é‡: <span id="imageQualityValue">85</span>%
      <input type="range" id="imageQuality" min="10" max="100" step="5" value="85">
    </label>
    <label>å›¾ç‰‡æœ€å¤§å°ºå¯¸: <span id="maxImageDimensionValue">2048</span>px
      <input type="range" id="maxImageDimension" min="512" max="4096" step="128" value="2048">
    </label>
    <label>æ–‡ä»¶å¤§å°é™åˆ¶: <span id="maxFileSizeValue">20</span>MB
      <input type="range" id="maxFileSize" min="1" max="100" step="1" value="20">
    </label>
  </div>

  <!-- ğŸ–¼ï¸ å›¾ç‰‡ä¸Šä¼  -->
  <div class="section">
    <h3>å›¾ç‰‡ä¸Šä¼ </h3>
    <input type="file" id="imageInput" accept="image/*">
    <label>æˆ–è¾“å…¥å›¾ç‰‡é“¾æ¥ï¼š</label>
    <input type="text" id="imageUrl" placeholder="https://example.com/image.jpg">
    <button id="loadImageBtn">åŠ è½½å¹¶é¢„è§ˆå›¾ç‰‡</button>
    <div><img id="imagePreview" class="preview" style="display:none;"></div>
    <button id="processImageBtn">æœ¬åœ°å¤„ç†å›¾ç‰‡</button>
    <button id="recognizeImageBtn">ä½¿ç”¨APIè¯†åˆ«å›¾ç‰‡</button>
  </div>

  <!-- ğŸ“„ æ–‡æ¡£ä¸Šä¼  -->
  <div class="section">
    <h3>æ–‡æ¡£ä¸Šä¼ </h3>
    <input type="file" id="docInput" accept=".txt,.json,.md,.html,.xml,.csv">
    <button id="processDocBtn">å¤„ç†æ–‡æ¡£</button>
    <button id="recognizeDocBtn">ä½¿ç”¨APIè¯†åˆ«æ–‡æ¡£</button>
  </div>

  <!-- ğŸŒ API é…ç½® -->
  <div class="section">
    <h3>é€‰æ‹© API æº</h3>
    <select id="apiSource">
      <option value="google">Google Gemini</option>
      <option value="kimi">Kimi (Moonshot)</option>
    </select>
  </div>

  <div class="section">
    <h3>Google API é…ç½®</h3>
    <label>API å¯†é’¥:<input type="text" id="googleKey" placeholder="è¾“å…¥Google API Key"></label>
    <button id="fetchGoogleModels">æ‹‰å–Googleæ¨¡å‹</button>
    <select id="googleModel"><option value="">ï¼ˆé»˜è®¤ gemini-2.0-flashï¼‰</option></select>
    <button id="testGoogleApi">æµ‹è¯•Google API</button>
  </div>

  <div class="section">
    <h3>Kimi API é…ç½®</h3>
    <label>API å¯†é’¥:<input type="text" id="kimiKey" placeholder="è¾“å…¥Kimi API Key"></label>
    <button id="fetchKimiModels">æ‹‰å–Kimiæ¨¡å‹</button>
    <select id="kimiModel"><option value="">è¯·é€‰æ‹©æ¨¡å‹</option></select>
    <button id="testKimiApi">æµ‹è¯•Kimi API</button>
  </div>

  <!-- çŠ¶æ€è¾“å‡º -->
  <div id="status">çŠ¶æ€è¾“å‡ºåŒº...</div>
</div>

<script>
  // === æŒä¹…åŒ–é…ç½® ===
  const savedConfig = JSON.parse(localStorage.getItem("apiConfig") || "{}");
  ["googleKey","googleModel","kimiKey","kimiModel","apiSource"].forEach(id=>{
    if(savedConfig[id]) document.getElementById(id).value = savedConfig[id];
  });
  function saveConfig(){
    const cfg={};
    ["googleKey","googleModel","kimiKey","kimiModel","apiSource"].forEach(id=>{
      cfg[id]=document.getElementById(id).value;
    });
    localStorage.setItem("apiConfig",JSON.stringify(cfg));
  }

  // === å¸¸é‡ï¼šGoogle OpenAI å…¼å®¹åŸºå€ ===
  const GOOGLE_BASE = "https://generativelanguage.googleapis.com/v1beta/openai/";

  // === å›¾ç‰‡å¤„ç†å™¨ ===
  class ImageProcessor {
    static async processImage(fileOrUrl){
      return new Promise((resolve,reject)=>{
        const img=new Image(); img.crossOrigin="anonymous";
        img.onload=()=>{
          let w=img.width,h=img.height;
          const maxDim=parseInt(document.getElementById("maxImageDimension").value);
          if(w>maxDim||h>maxDim){
            if(w>h){ h=(h*maxDim)/w; w=maxDim; }
            else{ w=(w*maxDim)/h; h=maxDim; }
          }
          const canvas=document.createElement("canvas");
          canvas.width=w; canvas.height=h;
          canvas.getContext("2d").drawImage(img,0,0,w,h);
          const q=document.getElementById("imageQuality").value/100;
          resolve({success:true,base64:canvas.toDataURL("image/jpeg",q)});
        };
        img.onerror=()=>reject(new Error("å›¾ç‰‡åŠ è½½å¤±è´¥"));
        if(typeof fileOrUrl==="string") img.src=fileOrUrl;
        else img.src=URL.createObjectURL(fileOrUrl);
      });
    }
  }

  // === æ–‡æ¡£å¤„ç†å™¨ ===
  class DocumentProcessor {
    static async processDocument(file){
      return new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=e=>resolve({success:true,content:e.target.result});
        reader.onerror=()=>reject(new Error("æ–‡ä»¶è¯»å–å¤±è´¥"));
        reader.readAsText(file,"utf-8");
      });
    }
  }

  // === Google APIï¼šæ¨¡å‹åˆ—è¡¨ï¼ˆOpenAI å…¼å®¹ /modelsï¼‰ ===
  async function fetchGoogleModels(){
    try{
      const key = document.getElementById("googleKey").value.trim();
      const res = await fetch(GOOGLE_BASE + "models", {
        headers: { "Authorization": "Bearer " + key }
      });
      const txt = await res.text();
      let data={};
      try{ data=JSON.parse(txt);}catch{}
      if(!data.data) throw new Error("æ— æ¨¡å‹å“åº”: "+txt);

      const sel=document.getElementById("googleModel");
      sel.innerHTML="";
      const placeholder=document.createElement("option");
      placeholder.value=""; placeholder.innerText="ï¼ˆé»˜è®¤ gemini-2.0-flashï¼‰";
      sel.appendChild(placeholder);

      data.data.forEach(m=>{
        const opt=document.createElement("option");
        opt.value=m.id || m.name || "";
        opt.innerText=m.id || m.name || "";
        sel.appendChild(opt);
      });
      saveConfig();
      setStatus("âœ… Googleæ¨¡å‹å·²æ›´æ–°", true);
    }catch(e){
      setStatus("âŒ æ‹‰å–Googleæ¨¡å‹å¤±è´¥: " + e.message, false);
    }
  }

  // === å›¾ç‰‡è¯†åˆ«ï¼ˆGoogle/Kimiï¼‰ ===
  async function recognizeImage(base64){
    const api=document.getElementById("apiSource").value;
    try{
      if(api==="google"){
        const key = document.getElementById("googleKey").value.trim();
        const model = document.getElementById("googleModel").value || "gemini-2.0-flash";
        const url = GOOGLE_BASE + "chat/completions";
        const messages = [
          {
            role: "user",
            content: [
              { type: "text", text: "What is in this image?" },
              { type: "image_url", image_url: { url: base64 } }
            ]
          }
        ];
        const res = await fetch(url, {
          method:"POST",
          headers:{
            "Authorization":"Bearer " + key,
            "Content-Type":"application/json"
          },
          body: JSON.stringify({ model, messages })
        });
        const txt=await res.text(); let data={raw:txt}; try{ data=JSON.parse(txt);}catch{}
        setStatus("âœ… Google å›¾ç‰‡è¯†åˆ«ç»“æœ:\n"+JSON.stringify(data,null,2), true);
      }else{
        const body={model:document.getElementById("kimiModel").value,messages:[{role:"user",content:[{type:"image_url",image_url:{url:base64}}]}]};
        const res=await fetch("https://api.moonshot.cn/v1/chat/completions",{method:"POST",headers:{"Authorization":"Bearer "+document.getElementById("kimiKey").value,"Content-Type":"application/json"},body:JSON.stringify(body)});
        const txt=await res.text(); let data={raw:txt}; try{ data=JSON.parse(txt);}catch{}
        setStatus("âœ… Kimi å›¾ç‰‡è¯†åˆ«ç»“æœ:\n"+JSON.stringify(data,null,2), true);
      }
    }catch(e){ setStatus("âŒ å›¾ç‰‡è¯†åˆ«å¤±è´¥: "+e.message, false); }
  }

  // === æ–‡æ¡£è¯†åˆ«ï¼ˆGoogle/Kimiï¼‰ ===
  async function recognizeDoc(text){
    const api=document.getElementById("apiSource").value;
    try{
      if(api==="google"){
        const key = document.getElementById("googleKey").value.trim();
        const model = document.getElementById("googleModel").value || "gemini-2.0-flash";
        const url = GOOGLE_BASE + "chat/completions";
        const content = text.length > 4000 ? text.slice(0,4000) : text;
        const body = {
          model,
          messages: [
            { role:"system", content:"You are a helpful assistant."},
            { role:"user", content }
          ]
        };
        const res = await fetch(url, {
          method:"POST",
          headers:{
            "Authorization":"Bearer " + key,
            "Content-Type":"application/json"
          },
          body: JSON.stringify(body)
        });
        const txt=await res.text(); let data={raw:txt}; try{ data=JSON.parse(txt);}catch{}
        setStatus("âœ… Google æ–‡æ¡£è¯†åˆ«ç»“æœ:\n"+JSON.stringify(data,null,2), true);
      }else{
        const body={model:document.getElementById("kimiModel").value,messages:[{role:"user",content:text.slice(0,4000)}]};
        const res=await fetch("https://api.moonshot.cn/v1/chat/completions",{method:"POST",headers:{"Authorization":"Bearer "+document.getElementById("kimiKey").value,"Content-Type":"application/json"},body:JSON.stringify(body)});
        const txt=await res.text(); let data={raw:txt}; try{ data=JSON.parse(txt);}catch{}
        setStatus("âœ… Kimi æ–‡æ¡£è¯†åˆ«ç»“æœ:\n"+JSON.stringify(data,null,2), true);
      }
    }catch(e){ setStatus("âŒ æ–‡æ¡£è¯†åˆ«å¤±è´¥: "+e.message, false); }
  }

  function setStatus(msg, injectInput=false){
    document.getElementById("status").innerText = msg;
    if(injectInput){
      window.parent.postMessage({
        type: "SmartMediaMessage",
        text: msg
      }, "*");
    }
  }

  // === UI ç»‘å®š ===
  document.getElementById("imageQuality").oninput=e=>{document.getElementById("imageQualityValue").innerText=e.target.value;};
  document.getElementById("maxImageDimension").oninput=e=>{document.getElementById("maxImageDimensionValue").innerText=e.target.value;};
  document.getElementById("maxFileSize").oninput=e=>{document.getElementById("maxFileSizeValue").innerText=e.target.value;};

  document.getElementById("loadImageBtn").onclick=()=>{
    const url=document.getElementById("imageUrl").value;
    if(url){document.getElementById("imagePreview").src=url;document.getElementById("imagePreview").style.display="block";}
  };

  document.getElementById("processImageBtn").onclick=async()=>{
    const file=document.getElementById("imageInput").files[0]; const url=document.getElementById("imageUrl").value;
    try{
      const result=await ImageProcessor.processImage(file||url);
      document.getElementById("imagePreview").src=result.base64;document.getElementById("imagePreview").style.display="block";
      setStatus("âœ… å›¾ç‰‡å¤„ç†æˆåŠŸï¼Œbase64é•¿åº¦ï¼š"+result.base64.length, true);
    }catch(e){setStatus("âŒ å›¾ç‰‡å¤„ç†å¤±è´¥: "+e.message, false);}
  };

  document.getElementById("recognizeImageBtn").onclick=async()=>{
    const file=document.getElementById("imageInput").files[0]; const url=document.getElementById("imageUrl").value;
    try{
      const result=await ImageProcessor.processImage(file||url);
      await recognizeImage(result.base64);
    }catch(e){setStatus("âŒ è¯†åˆ«å¤±è´¥: "+e.message, false);}
  };

  document.getElementById("processDocBtn").onclick=async()=>{
    const file=document.getElementById("docInput").files[0];
    if(!file) return alert("è¯·é€‰æ‹©æ–‡æ¡£");
    try{
      const result=await DocumentProcessor.processDocument(file);
      setStatus("âœ… æ–‡æ¡£å¤„ç†æˆåŠŸï¼Œå‰200å­—ï¼š\n"+result.content.slice(0,200), true);
    }catch(e){setStatus("âŒ æ–‡æ¡£å¤„ç†å¤±è´¥: "+e.message, false);}
  };

  document.getElementById("recognizeDocBtn").onclick=async()=>{
    const file=document.getElementById("docInput").files[0];
    if(!file) return alert("è¯·é€‰æ‹©æ–‡æ¡£");
    try{
      const result=await DocumentProcessor.processDocument(file);
      await recognizeDoc(result.content);
    }catch(e){setStatus("âŒ æ–‡æ¡£è¯†åˆ«å¤±è´¥: "+e.message, false);}
  };

  document.getElementById("fetchGoogleModels").onclick=fetchGoogleModels;
  document.getElementById("testGoogleApi").onclick=testGoogleApi;
  document.getElementById("fetchKimiModels").onclick=fetchKimiModels;
  document.getElementById("testKimiApi").onclick=testKimiApi;

</script>

</body>
</html>
